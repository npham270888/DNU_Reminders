{% extends "base.html" %}

{% block title %}Lịch sự kiện - DNU Reminder{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
            <div class="flex items-center space-x-4">
                <div class="p-3 rounded-full bg-primary bg-opacity-10">
                    <i class="fas fa-calendar text-primary text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Lịch sự kiện</h2>
                    <p class="text-gray-600">Xem tất cả sự kiện theo lịch tháng</p>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                <a href="{{ url_for('authorize_google_calendar') }}" 
                   class="btn-primary py-2 px-4 rounded-lg font-medium flex items-center justify-center">
                    <i class="fab fa-google mr-2"></i>Kết nối Google Calendar
                </a>
                <a href="{{ url_for('sync_to_google_calendar') }}" 
                   class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium flex items-center justify-center">
                    <i class="fas fa-sync mr-2"></i>Đồng bộ lịch
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Main Calendar Section -->
        <div class="lg:col-span-3 space-y-6">
            <!-- Calendar Controls -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex space-x-2">
                        <button type="button" onclick="previousMonth()" 
                                class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button type="button" id="currentMonthBtn"
                                class="py-2 px-4 rounded-lg bg-primary text-white hover:bg-opacity-90 transition">
                            Tháng hiện tại
                        </button>
                        <button type="button" onclick="nextMonth()"
                                class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <button type="button" onclick="debugEvents()"
                            class="py-2 px-4 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition flex items-center">
                        <i class="fas fa-bug mr-2"></i>Debug
                    </button>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="grid grid-cols-7 border-b border-gray-200">
                    <div class="py-3 text-center font-medium text-gray-600">CN</div>
                    <div class="py-3 text-center font-medium text-gray-600">T2</div>
                    <div class="py-3 text-center font-medium text-gray-600">T3</div>
                    <div class="py-3 text-center font-medium text-gray-600">T4</div>
                    <div class="py-3 text-center font-medium text-gray-600">T5</div>
                    <div class="py-3 text-center font-medium text-gray-600">T6</div>
                    <div class="py-3 text-center font-medium text-gray-600">T7</div>
                </div>
                
                <div class="calendar-body p-4" id="calendarBody">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-filter text-primary"></i>
                        <h6 class="font-semibold text-gray-800 m-0">Lọc sự kiện</h6>
                    </div>
                </div>
                <div class="p-4 space-y-3">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="filterClass" checked
                               class="rounded border-gray-300 text-primary focus:ring-primary">
                        <span class="text-gray-700">
                            <i class="fas fa-graduation-cap mr-2 text-green-600"></i>Lịch học
                        </span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="filterAssignment" checked
                               class="rounded border-gray-300 text-primary focus:ring-primary">
                        <span class="text-gray-700">
                            <i class="fas fa-book mr-2 text-yellow-600"></i>Bài tập
                        </span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="filterExam" checked
                               class="rounded border-gray-300 text-primary focus:ring-primary">
                        <span class="text-gray-700">
                            <i class="fas fa-file-alt mr-2 text-red-600"></i>Thi cử
                        </span>
                    </label>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md mt-4">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-info-circle text-primary"></i>
                        <h6 class="font-semibold text-gray-800 m-0">Chú thích</h6>
                    </div>
                </div>
                <div class="p-4 space-y-2">
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-green-500 rounded-full mr-3"></span>
                        <small class="text-gray-600">Lịch học</small>
                    </div>
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></span>
                        <small class="text-gray-600">Bài tập</small>
                    </div>
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-red-500 rounded-full mr-3"></span>
                        <small class="text-gray-600">Thi cử</small>
                    </div>
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-3"></span>
                        <small class="text-gray-600">Nguồn khác</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="relative z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true" id="eventModal" style="display: none;">
    <!-- Background backdrop -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>

    <!-- Modal panel -->
    <div class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-xl transition-all w-full max-w-lg">
                <!-- Header -->
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900" id="eventModalTitle">Chi tiết sự kiện</h3>
                    <button type="button" onclick="closeEventModal()" class="text-gray-400 hover:text-gray-500">
                        <span class="sr-only">Đóng</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="px-6 py-4" id="eventModalBody">
                    <!-- Event details will be populated here -->
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-end space-x-3">
                    <button type="button" 
                            onclick="closeEventModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                        Đóng
                    </button>
                    <a href="#" 
                       id="editEventBtn"
                       class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors inline-flex items-center">
                        <i class="fas fa-edit mr-2"></i>Sửa
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-day {
    min-height: 120px;
    border: 1px solid #dee2e6;
    cursor: pointer;
    overflow: hidden;
    transition: background-color 0.2s ease;
}

.calendar-day:hover {
    background-color: #f8f9fa;
}

.day-number {
    font-weight: bold;
    text-align: center;
}

.event-item {
    transition: all 0.2s ease;
    border: 1px solid rgba(0,0,0,0.1);
}

.event-item:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.event-dot {
    cursor: pointer;
    transition: transform 0.2s;
}

.event-dot:hover {
    transform: scale(1.2);
}

.calendar-row {
    min-height: 100px;
}

/* Modal Animation Styles */
.modal-backdrop-enter {
    opacity: 0;
    transition: opacity 0.2s ease-out;
}
.modal-backdrop-enter-active {
    opacity: 0.75;
}
.modal-content-enter {
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.2s ease-out;
}
.modal-content-enter-active {
    opacity: 1;
    transform: translateY(0);
}
</style>

<script>
let currentDate = new Date();
let events = {{ events|tojson }};

// Convert events to more usable format
events = events.map(event => {
    const eventDate = new Date(event.datetime);
    console.log(`Processing event: ${event.title}, datetime: ${event.datetime}, parsed: ${eventDate}`);
    
    return {
        ...event,
        date: eventDate,
        day: eventDate.getDate(),
        month: eventDate.getMonth(),
        year: eventDate.getFullYear()
    };
});

// Debug: Log events to console
console.log('Events loaded:', events);
console.log('Events count:', events.length);

function closeEventModal() {
    const modal = document.getElementById('eventModal');
    
    // Thêm animation khi đóng
    const backdrop = modal.querySelector('.bg-gray-500');
    const content = modal.querySelector('.transform');
    
    backdrop.classList.remove('opacity-75');
    content.classList.remove('translate-y-0', 'opacity-100');
    
    // Đợi animation hoàn thành rồi ẩn modal
    setTimeout(() => {
        modal.style.display = 'none';
    }, 200);
}

function showEventDetails(event) {
    console.log('showEventDetails called with:', event); // Debug log
    
    const modalTitle = document.getElementById('eventModalTitle');
    const modalBody = document.getElementById('eventModalBody');
    const modal = document.getElementById('eventModal');
    
    // Check if elements exist
    if (!modalTitle || !modalBody || !modal) {
        console.error('Modal elements not found!');
        return;
    }
    
    modalTitle.textContent = event.title;
    
    // Xác định màu sắc dựa trên loại sự kiện
    let typeColorClass;
    if (event.event_type === 'Class') {
        typeColorClass = 'bg-green-100 text-green-800';
    } else if (event.event_type === 'Assignment') {
        typeColorClass = 'bg-yellow-100 text-yellow-800';
    } else if (event.event_type === 'Exam') {
        typeColorClass = 'bg-red-100 text-red-800';
    } else {
        typeColorClass = 'bg-blue-100 text-blue-800';
    }
    
    modalBody.innerHTML = `
        <div class="space-y-4">
            <div class="flex items-center">
                <span class="font-medium mr-2">Loại:</span>
                <span class="px-2 py-1 text-sm font-medium rounded-full ${typeColorClass}">
                    ${event.event_type}
                </span>
            </div>

            <div class="space-y-2">
                <div class="font-medium">Thời gian:</div>
                <div class="flex items-center text-gray-600 ml-2">
                    <i class="fas fa-calendar mr-2"></i>
                    ${new Date(event.datetime).toLocaleDateString('vi-VN')}
                </div>
                <div class="flex items-center text-gray-600 ml-2">
                    <i class="fas fa-clock mr-2"></i>
                    ${new Date(event.datetime).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})}
                </div>
            </div>

            ${event.description ? `
            <div class="space-y-2">
                <div class="font-medium">Mô tả:</div>
                <div class="text-gray-600 ml-2 whitespace-pre-wrap">${event.description}</div>
            </div>
            ` : ''}

            <div class="flex items-center">
                <span class="font-medium mr-2">Nguồn:</span>
                <span class="px-2 py-1 text-sm font-medium bg-blue-100 text-blue-800 rounded-full">
                    ${event.source}
                </span>
            </div>
        </div>
    `;
    
    document.getElementById('editEventBtn').href = `/events/${event.id}/edit`;
    
    // Hiển thị modal
    modal.style.display = 'block';
    
    // Thêm classes animation
    const backdrop = modal.querySelector('.bg-gray-500');
    const content = modal.querySelector('.transform');
    
    // Reset animation classes
    backdrop.classList.remove('opacity-75');
    content.classList.remove('translate-y-0', 'opacity-100');
    
    // Force reflow
    void backdrop.offsetWidth;
    
    // Add animation classes
    backdrop.classList.add('modal-backdrop-enter', 'modal-backdrop-enter-active');
    content.classList.add('modal-content-enter', 'modal-content-enter-active');
    
    // Clean up animation classes
    setTimeout(() => {
        backdrop.classList.remove('modal-backdrop-enter', 'modal-backdrop-enter-active');
        content.classList.remove('modal-content-enter', 'modal-content-enter-active');
        backdrop.classList.add('opacity-75');
        content.classList.add('translate-y-0', 'opacity-100');
    }, 200);
}

function generateCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Update header
    document.getElementById('currentMonthBtn').textContent = `Tháng ${month + 1} năm ${year}`;
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarBody = document.getElementById('calendarBody');
    calendarBody.innerHTML = '';
    
    // Create calendar grid using CSS Grid
    const calendarGrid = document.createElement('div');
    calendarGrid.className = 'grid grid-cols-7 gap-1';
    
    for (let i = 0; i < 42; i++) {
        const currentCalendarDate = new Date(startDate);
        currentCalendarDate.setDate(startDate.getDate() + i);
        
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day p-2 rounded-lg';
        
        const isCurrentMonth = currentCalendarDate.getMonth() === month;
        const isToday = currentCalendarDate.toDateString() === new Date().toDateString();
        
        if (!isCurrentMonth) {
            dayCell.classList.add('text-gray-400', 'bg-gray-50');
        }
        if (isToday) {
            dayCell.classList.add('bg-blue-500', 'text-white');
        }
        
        // Day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number mb-1 font-semibold';
        dayNumber.textContent = currentCalendarDate.getDate();
        dayCell.appendChild(dayNumber);
        
        // Events for this day
        const dayEvents = events.filter(event => {
            const match = event.day === currentCalendarDate.getDate() && 
                         event.month === currentCalendarDate.getMonth() && 
                         event.year === currentCalendarDate.getFullYear();
            
            if (match) {
                console.log(`Event ${event.title} matches date ${currentCalendarDate.getDate()}/${currentCalendarDate.getMonth() + 1}/${currentCalendarDate.getFullYear()}`);
            }
            
            return match;
        });
        
        // Debug: Log events for this day
        if (dayEvents.length > 0) {
            console.log(`Events for ${currentCalendarDate.getDate()}/${currentCalendarDate.getMonth() + 1}/${currentCalendarDate.getFullYear()}:`, dayEvents);
        }
        
        dayEvents.forEach((event, index) => {
            // Limit to 3 events per day to avoid overcrowding
            if (index >= 3) return;
            
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item text-xs text-truncate mb-1 px-2 py-1 rounded cursor-pointer';
            
            // Color based on event type
            let bgColorClass, textColorClass;
            if (event.event_type === 'Class') {
                bgColorClass = 'bg-green-500';
                textColorClass = 'text-white';
            } else if (event.event_type === 'Assignment') {
                bgColorClass = 'bg-yellow-400';
                textColorClass = 'text-black';
            } else if (event.event_type === 'Exam') {
                bgColorClass = 'bg-red-500';
                textColorClass = 'text-white';
            } else {
                bgColorClass = 'bg-blue-500';
                textColorClass = 'text-white';
            }
            
            eventItem.classList.add(bgColorClass, textColorClass);
            
            // Show time and title
            const eventTime = new Date(event.datetime).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
            eventItem.textContent = `${eventTime} ${event.title}`;
            
            // Add tooltip for full title
            eventItem.title = `${eventTime} - ${event.title}`;
            
            // Fixed event handler with stopPropagation
            eventItem.addEventListener('click', (e) => {
                e.stopPropagation(); // Ngăn sự kiện click lan ra calendar-day
                console.log('Event clicked:', event.title); // Debug log
                showEventDetails(event);
            });
            
            dayCell.appendChild(eventItem);
        });
        
        // Show "..." if there are more than 3 events
        if (dayEvents.length > 3) {
            const moreEvents = document.createElement('div');
            moreEvents.className = 'text-gray-500 text-xs text-center cursor-pointer hover:text-gray-700';
            moreEvents.textContent = `+${dayEvents.length - 3} khác`;
            
            moreEvents.addEventListener('click', (e) => {
                e.stopPropagation(); // Fixed: Added stopPropagation
                // Show all events for this day
                const eventsList = dayEvents.map(event => {
                    const eventTime = new Date(event.datetime).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
                    return `${eventTime} - ${event.title}`;
                }).join('\n');
                alert(`Tất cả sự kiện ngày ${currentCalendarDate.getDate()}/${currentCalendarDate.getMonth() + 1}:\n\n${eventsList}`);
            });
            
            dayCell.appendChild(moreEvents);
        }
        
        calendarGrid.appendChild(dayCell);
    }
    
    calendarBody.appendChild(calendarGrid);
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar();
}

// Filter events
document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', generateCalendar);
});

function debugEvents() {
    console.log('=== DEBUG EVENTS ===');
    console.log('Total events:', events.length);
    console.log('Events data:', events);
    
    // Check current month
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    console.log(`Current month: ${currentMonth + 1}, year: ${currentYear}`);
    
    // Filter events for current month
    const monthEvents = events.filter(event => 
        event.month === currentMonth && event.year === currentYear
    );
    console.log(`Events in current month: ${monthEvents.length}`, monthEvents);
    
    // Show alert with summary
    alert(`Debug Info:\nTotal events: ${events.length}\nEvents this month: ${monthEvents.length}\nCheck console for details`);
}

// Initialize calendar when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing calendar...');
    generateCalendar();
});

// Close modal when clicking outside
document.addEventListener('click', (e) => {
    const modal = document.getElementById('eventModal');
    if (modal && modal.style.display !== 'none' && e.target === modal.querySelector('.fixed.inset-0.z-50')) {
        closeEventModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const modal = document.getElementById('eventModal');
        if (modal && modal.style.display !== 'none') {
            closeEventModal();
        }
    }
});
</script>
{% endblock %}

{% block scripts %}
<!-- Additional scripts if needed -->
{% endblock %}