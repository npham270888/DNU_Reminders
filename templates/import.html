{% extends "base.html" %}

{% block title %}Import sự kiện - DNU Reminder{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-primary">
            <i class="fas fa-upload me-2"></i>Import sự kiện từ JSON
        </h2>
        <p class="text-muted">Nhập lịch học, bài tập, thi cử từ file JSON</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card border-0 shadow">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-upload me-2"></i>Upload file JSON
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">Chọn file JSON</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".json" required>
                        <div class="form-text">Chỉ hỗ trợ file JSON với định dạng chuẩn</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-upload me-2"></i>Import sự kiện
                    </button>
                </form>
                
                <hr class="my-4">
                
                <div class="alert alert-info">
                    <h6 class="alert-heading">
                        <i class="fas fa-info-circle me-2"></i>Định dạng file JSON
                    </h6>
                    <p class="mb-2">File JSON phải có cấu trúc như sau:</p>
                    <pre class="bg-light p-2 rounded small"><code>[
  {
    "title": "Tên sự kiện",
    "event_type": "Class|Assignment|Exam",
    "datetime": "2024-01-15T14:30:00",
    "description": "Mô tả sự kiện (không bắt buộc)"
  }
]</code></pre>
                </div>
            </div>
        </div>
        
        <!-- Sample JSON -->
        <div class="card border-0 shadow mt-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-download me-2"></i>Tải file mẫu
                </h6>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">Tải file JSON mẫu để tham khảo định dạng</p>
                <button class="btn btn-outline-primary btn-sm" onclick="downloadSample()">
                    <i class="fas fa-download me-2"></i>Tải file mẫu
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-0 shadow">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Lịch sử import
                </h5>
            </div>
            <div class="card-body">
                {% if imports %}
                    <div class="list-group list-group-flush">
                        {% for import_record in imports %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ import_record.filename }}</h6>
                                    <p class="text-muted mb-1">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ import_record.import_date.strftime('%d/%m/%Y %H:%M') }}
                                    </p>
                                    <span class="badge 
                                        {% if import_record.status == 'Success' %}bg-success
                                        {% else %}bg-danger{% endif %}">
                                        {{ import_record.status }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Chưa có lịch sử import nào</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Import Tips -->
        <div class="card border-0 shadow mt-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Mẹo import
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <small>Đảm bảo định dạng datetime đúng chuẩn ISO</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <small>event_type phải là một trong: Class, Assignment, Exam</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <small>File không quá 1MB để tránh timeout</small>
                    </li>
                    <li>
                        <i class="fas fa-check text-success me-2"></i>
                        <small>Kiểm tra encoding UTF-8 để hiển thị tiếng Việt</small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function downloadSample() {
    const sampleData = [
        {
            "title": "Lịch học môn Lập trình Web",
            "event_type": "Class",
            "datetime": "2024-01-15T08:00:00",
            "description": "Học về HTML, CSS cơ bản"
        },
        {
            "title": "Nộp bài tập môn Toán",
            "event_type": "Assignment",
            "datetime": "2024-01-16T23:59:00",
            "description": "Bài tập chương 1 - Đạo hàm"
        },
        {
            "title": "Thi giữa kỳ môn Lập trình",
            "event_type": "Exam",
            "datetime": "2024-01-20T09:00:00",
            "description": "Thi lý thuyết và thực hành"
        }
    ];
    
    const dataStr = JSON.stringify(sampleData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'sample_events.json';
    link.click();
}
</script>
{% endblock %}
