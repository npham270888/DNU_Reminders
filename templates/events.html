{% extends "base.html" %}

{% block title %}Quản lý sự kiện - DNU Reminder{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <div class="flex flex-col md:flex-row items-center justify-between">
            <div class="mb-4 md:mb-0">
                <div class="flex items-center space-x-4">
                    <div class="p-3 rounded-full bg-primary bg-opacity-10">
                        <i class="fas fa-list text-primary text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Quản lý sự kiện</h2>
                        <p class="text-gray-600">Quản lý tất cả sự kiện học tập của bạn</p>
                    </div>
                </div>
            </div>
            <a href="{{ url_for('new_event') }}" class="btn-primary py-2 px-4 rounded-lg font-medium flex items-center shadow-sm hover:shadow-md transition-all">
                <i class="fas fa-plus mr-2"></i>Tạo sự kiện mới
            </a>
        </div>
    </div>

{% if events %}
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
                <h5 class="font-semibold text-gray-800">Danh sách sự kiện ({{ events|length }})</h5>
                <div class="flex space-x-2">
                    <button type="button" onclick="filterEvents('all')" 
                            class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition">
                        Tất cả
                    </button>
                    <button type="button" onclick="filterEvents('Class')" 
                            class="px-4 py-2 rounded-lg text-sm font-medium bg-green-100 text-green-700 hover:bg-green-200 transition">
                        Lịch học
                    </button>
                    <button type="button" onclick="filterEvents('Assignment')" 
                            class="px-4 py-2 rounded-lg text-sm font-medium bg-yellow-100 text-yellow-700 hover:bg-yellow-200 transition">
                        Bài tập
                    </button>
                    <button type="button" onclick="filterEvents('Exam')" 
                            class="px-4 py-2 rounded-lg text-sm font-medium bg-red-100 text-red-700 hover:bg-red-200 transition">
                        Thi cử
                    </button>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiêu đề</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loại</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nguồn</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                        {% for event in events %}
                        <tr class="event-row hover:bg-gray-50" data-type="{{ event.event_type }}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="max-w-lg">
                                    <div class="text-sm font-medium text-gray-900">{{ event.title }}</div>
                                    {% if event.description %}
                                        <div class="text-sm text-gray-500 truncate">
                                            {{ event.description[:100] }}{% if event.description|length > 100 %}...{% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 text-xs font-medium rounded-full
                                    {% if event.event_type == 'Class' %}bg-green-100 text-green-800
                                    {% elif event.event_type == 'Assignment' %}bg-yellow-100 text-yellow-800
                                    {% elif event.event_type == 'Exam' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ event.event_type }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    <i class="fas fa-calendar mr-1 text-gray-400"></i>
                                    {{ event.datetime.strftime('%d/%m/%Y') }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>
                                    {{ event.datetime.strftime('%H:%M') }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                    {{ event.source }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex items-center space-x-2">
                                    <a href="{{ url_for('edit_event', event_id=event.id) }}" 
                                       class="text-primary hover:text-primary-dark transition p-2 rounded-lg hover:bg-gray-100">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" onclick="deleteEvent({{ event.id }}, '{{ event.title }}')"
                                            class="text-red-600 hover:text-red-900 transition p-2 rounded-lg hover:bg-gray-100">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% else %}
    <div class="card border-0 shadow">
        <div class="card-body text-center py-5">
            <i class="fas fa-calendar-times fa-4x text-muted mb-4"></i>
            <h4 class="text-muted mb-3">Chưa có sự kiện nào</h4>
            <p class="text-muted mb-4">Bắt đầu tạo sự kiện đầu tiên để quản lý lịch học của bạn</p>
            <a href="{{ url_for('new_event') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus me-2"></i>Tạo sự kiện đầu tiên
            </a>
        </div>
    </div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div class="relative z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true" id="deleteModal" style="display: none;">
    <!-- Background backdrop -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>

    <!-- Modal panel -->
    <div class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-xl bg-white/95 backdrop-blur-md text-left shadow-xl transition-all w-full max-w-md">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-200/80">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-600 text-lg"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900" id="modal-title">
                            Xác nhận xóa
                        </h3>
                    </div>
                </div>

                <!-- Content -->
                <div class="px-6 py-4">
                    <p class="text-gray-600">
                        Bạn có chắc chắn muốn xóa sự kiện "<span id="eventTitle" class="font-medium text-gray-900"></span>"?
                    </p>
                    <div class="mt-2 flex items-center text-sm text-red-600">
                        <i class="fas fa-info-circle mr-2"></i>
                        <p>Hành động này không thể hoàn tác.</p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-gray-50/80 border-t border-gray-200/80 flex items-center justify-end space-x-3">
                    <button type="button" 
                            onclick="closeDeleteModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                        Hủy
                    </button>
                    <form id="deleteForm" method="POST" class="inline-block">
                        <button type="submit" 
                                class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                            Xóa
                        </button>
                    </form>
                </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function filterEvents(type) {
    const rows = document.querySelectorAll('.event-row');
    rows.forEach(row => {
        if (type === 'all' || row.dataset.type === type) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function deleteEvent(eventId, eventTitle) {
    const modal = document.getElementById('deleteModal');
    document.getElementById('eventTitle').textContent = eventTitle;
    document.getElementById('deleteForm').action = `/events/${eventId}/delete`;
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('deleteModal');
    const modalContent = document.querySelector('.transform.bg-white');
    if (!modalContent.contains(event.target) && modal.style.display === 'block') {
        closeDeleteModal();
    }
});

// Close modal on Escape key press
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && document.getElementById('deleteModal').style.display === 'block') {
        closeDeleteModal();
    }
});
</script>
{% endblock %}
